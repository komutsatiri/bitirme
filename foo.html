<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bitirme</title>	

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2/leaflet.css" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="./css/MarkerCluster.css" />
<link rel="stylesheet" href="./css/MarkerCluster.Default.css" />
<link rel="stylesheet" href="./css/leaflet-search.src.css" />
<link rel="stylesheet" href="./css/foo.css" />
<!--jquery js-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
	  	integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
		crossorigin="anonymous">
</script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.2/jquery.ui.touch-punch.min.js"></script>	
<!--leaflet js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2/leaflet.js"></script>
<script src="./js/leaflet-search.src.js"></script>
<script src="./js/leaflet.markercluster-src.js"></script>
<script src="./js/subgroup.js"></script>
<script src="https://unpkg.com/leaflet.markercluster.layersupport@1.0.2/dist/leaflet.markercluster.layersupport.js"></script>
<script src="./js/leaflet-sliderControl.js"></script>
<script src="./js/dyad-control.js"></script>
</head>

<body>
<div id="mapid"></div>


<script type="text/javascript">
$(document).ready(function(){

	
	var map = L.map('mapid').setView([38.99357, 35.24414], 6);
	L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    	maxZoom: 14,
    	minZoom: 4,
	}).addTo(map);


	var markers = L.layerGroup();
	var layer_support = L.markerClusterGroup.layerSupport();

	var sliderControl = L.control.sliderControl({
		position: "topright",
   		layer: markers,
   		follow: 600
   	});
	
	function populate(event_object,layer){
		for (var key in event_object){
				var event = event_object[key];
				//var marker_title = event_object[key]['id'];//+", "+event_object[key]['year'];
				var marker = L.marker([event.lat, event.lon],{title : event.id, time: event.time.toString()});
				marker.bindPopup("init");
				marker.addTo(layer);	
		}
		layer_support.addTo(map).checkIn(layer);
		map.addControl(sliderControl);
		sliderControl.startSlider();		
	}	
	
	$.getJSON("http://localhost:5000/markers",{
		format: "json"
	})	
	.done(function(data){
			
		populate(data.result,markers);
	})
	.fail(function( jqxhr, textStatus, error ) {
   		var err = textStatus + ", " + error;
		console.log( "Request failed while getting markers: " + err );
	});

	
	map.addControl(new DyadControl('dyad_list',
		{position: 'topright'}
	));


	layer_support.on('mouseover', function(e){
	
		var el = $(e.layer.options),
			title = el.attr("title");
		var popup_content = e.layer._popup._content;
			
		if (popup_content == 'init')
		{	
			$.getJSON("http://localhost:5000/details/"+title,{
				format: "json"
			})	
			.done(function(data){
			
				e.layer._popup._content = data.result.source_article;
			})
			.fail(function( jqxhr, textStatus, error ) {
   				var err = textStatus + ", " + error;
				console.log( "Request failed while getting details: " + err );
			});
		}
	});

});
</script>
</body>
</html>
